GITREF=`git describe --dirty --long --tags`

# $(VERSION_GO) will be written to version.go
VERSION_GO="/* DO NOT EDIT THIS FILE. IT IS GENERATED BY 'make setver'*/\n\n\
package teleport\n\
const( Version = \"$(VERSION)\" )\n\
// Gitref variable is automatically set to the output of "git-describe" \n\
// during the build process\n\
var Gitref string\n"

# $(GIT_GO) will be written to gitref.go
GITREF_GO="/* DO NOT EDIT THIS FILE. IT IS GENERATED BY make */ \n\n\
package teleport\n\
func init() { Gitref = \"$(GITREF)\"}  "

#
# setver updates version.go and gitref.go with VERSION and GITREF vars
#
.PHONY:setver
setver: helm-version
	@printf $(VERSION_GO) | gofmt > version.go
	@printf $(GITREF_GO) | gofmt > gitref.go

# helm-version automatically updates the versions of Helm charts to match the version in the Makefile
# so that the chart versions are kept in sync with the published Teleport version number.
# '-dev' is automatically removed from the version if it is present (as it is on the master branch)
# as we don't currently publish nightly Docker images.
.PHONY:helm-version
helm-version:
	@export TRIMMED_VERSION=$$(echo $(VERSION) | cut -d. -f1) && \
	sed -i "s_^version:\ .*_version: \"$${TRIMMED_VERSION}\"_g" examples/chart/teleport-kube-agent/Chart.yaml && \
	sed -i "s_^version:\ .*_version: \"$${TRIMMED_VERSION}\"_g" examples/chart/teleport-cluster/Chart.yaml